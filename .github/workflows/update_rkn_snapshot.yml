# Best-effort обновление снапшота РКН для колонки в UI.
# Официальный дамп реестра РКН через портал выгрузок на GitHub Pages повторить нельзя.
# Используется неофициальный источник (rknweb.ru API), если доступен.
name: Update RKN snapshot

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch allow-domains list
        run: |
          URL="https://raw.githubusercontent.com/itdoginfo/allow-domains/main/Russia/inside-raw.lst"
          curl -sfL "$URL" -o /tmp/inside.lst || true
          touch /tmp/our_domains.txt
          [ -s /tmp/inside.lst ] || exit 0
          grep -v '^#' /tmp/inside.lst | sed 's/#.*//' | awk '{print $1}' | grep -E '^[a-zA-Z0-9][a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$' | sort -u | head -300 > /tmp/our_domains.txt

      - name: Build RKN snapshot
        run: |
          python3 << 'PYEOF'
          import json
          import urllib.request
          import os

          updated = __import__('datetime').datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')
          our_domains = []
          try:
              with open('/tmp/our_domains.txt') as f:
                  our_domains = [line.strip().lower() for line in f if line.strip()]
          except FileNotFoundError:
              pass

          blocked = set()
          try:
              req = urllib.request.Request(
                  'https://rknweb.ru/api/v3/domains/',
                  headers={'User-Agent': 'GitHub-Actions-CheckSites/1.0'}
              )
              with urllib.request.urlopen(req, timeout=30) as r:
                  data = json.loads(r.read().decode())
              if isinstance(data, list):
                  for item in data:
                      d = item.get('domain', item) if isinstance(item, dict) else item
                      if isinstance(d, str) and '.' in d:
                          blocked.add(d.lower())
              elif isinstance(data, dict):
                  for item in data.get('results', data.get('domains', [])) or []:
                      d = item.get('domain', item) if isinstance(item, dict) else item
                      if isinstance(d, str) and '.' in d:
                          blocked.add(d.lower())
          except Exception:
              pass

          domains = {d: (d in blocked) for d in our_domains}
          out = {
              "updated": updated,
              "note": "Snapshot from GitHub Action. Source: allow-domains + rknweb.ru API (best-effort).",
              "domains": domains
          }
          os.makedirs('data', exist_ok=True)
          with open('data/rkn_snapshot.json', 'w', encoding='utf-8') as f:
              json.dump(out, f, ensure_ascii=False, indent=2)
          print("Wrote data/rkn_snapshot.json with", len(domains), "domains")
          PYEOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/rkn_snapshot.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update RKN snapshot [automated]"
            git push
          fi
